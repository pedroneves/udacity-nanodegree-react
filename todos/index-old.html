<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Udacity ToDo App</title>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
	<script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
	<script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
	<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
	<script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
	<script src="https://unpkg.com/redux-thunk@2.2.0/dist/redux-thunk.min.js"></script>
	<script src="https://unpkg.com/react-redux@5.0.6/dist/react-redux.min.js"></script>
</head>
<body>

	<div id="app-root"></div>

	<script>

		// Aux functions


		// Action types

		// Action Creators

		// Thunks

		// Reducers

		// Middlewares
		const alertBitcoin = (store) => (next) => (action) => {
			const shouldVerify = [ADD_TODO, ADD_GOAL].includes(action.type);

			if (shouldVerify) {
				let name = action.todo ? action.todo.name : action.goal.name;

				if (name.toLowerCase().includes('bitcoin')){
					return alert('Check bitcoin.org first')
				}
			}

			next(action)
		}

		const logger = (store) => (next) => (action) => {
			console.group(action.type);

			console.log('Prev state:', store.getState())
			console.log('Action:', action);
			const result = next(action);
			console.log('New state:', store.getState())

			console.groupEnd(action.type);

			return result
		}

		// App
		const store = Redux.createStore(
			Redux.combineReducers({
				goals,
				todos,
				loading
			}),
			Redux.applyMiddleware(
				ReduxThunk.default,
				alertBitcoin,
				logger
			)
		);
	</script>

	<script type="text/babel">
		function ListItem (props) {
			const {value, isDone, onToggleItem, onRemoveItem} = props;

			const style = {
				textDecoration: isDone ? 'line-through' : 'none'
			};

			return (
				<li>
					<span onClick={onToggleItem} style={style}>{value}</span>
					<button onClick={onRemoveItem}>X</button>
				</li>
			);
		}

		function List (props) {
			const {
				items,
				onCompleteItem = () => {},
				onRemoveItem = () => {}
			} = props;

			return (
				<ul>
				{
					items.map(item => (
						<ListItem
							key={item.id}
							value={item.name}
							isDone={item.isDone}
							onToggleItem={() => onCompleteItem(item)}
							onRemoveItem={() => onRemoveItem(item)}
						/>
					))
				}
				</ul>
			);
		}

		class Todos extends React.Component {

			handleAddItem = (event) => {
				event.preventDefault();
				const name = this.todoInput.value;

				this.todoInput.disabled = true;
				this.addTodoBtn.disabled = true;

				this.props.dispatch(
					addToDoThunk(name, (error) => {
						if (error) {
							alert(error.message)
						} else {
							this.todoInput.value = '';
						}
						this.todoInput.disabled = false
						this.addTodoBtn.disabled = false;
					})
				)
			}

			onCompleteTodo = (item) => {
				this.props.dispatch(
					toggleToDoThunk(item, (error) => {
						if(error) { alert(error.message) }
					})
				)
			}

			onRemoveTodo = (item) => {
				this.props.dispatch(
					removeToDoThunk(item, (error) => {
						if(error) { alert(error.message) }
					})
				)
			}

			render () {
				return (
					<div>
						<h1>To-do List</h1>
						<form onSubmit={this.handleAddItem}>
							<input
								type="text"
								placeholder="Add todo"
								ref={(input) => this.todoInput = input}
							/>
							<button
								onClick={this.handleAddItem}
								ref={(addTodoBtn => this.addTodoBtn = addTodoBtn)}
							>
								Add To-Do
							</button>
						</form>

						<List
							items={this.props.todos}
							onCompleteItem={this.onCompleteTodo}
							onRemoveItem={this.onRemoveTodo}
						/>
					</div>
				);
			}
		}

		const ConnectedTodos = ReactRedux.connect((state) => ({
			todos: state.todos
		}))(Todos)

		class Goals extends React.Component {

			handleAddItem = (event) => {
				event.preventDefault()
				const name = this.goalInput.value;

				this.goalInput.disabled = true;
				this.addGoalBtn.disabled = true;

				this.props.dispatch(
					addGoalThunk(name, (error) => {
						if (error) {
							alert(error.message)
						} else {
							this.goalInput.value = '';
						}
						this.goalInput.disabled = false
						this.addGoalBtn.disabled = false;
					})
				)
			}

			onRemoveGoal = (item) => {
				this.props.dispatch(
					removeGoalThunk(item, (error) => {
						if(error) { alert(error.message) }
					})
				)
			}

			render () {
				return (
					<div>
						<h1>Goals List</h1>

						<form onSubmit={this.handleAddItem}>
							<input
								type="text"
								placeholder="Add goal"
								ref={(input) => this.goalInput = input}
							/>
							<button
								onClick={this.handleAddItem}
								ref={(addGoalBtn => this.addGoalBtn = addGoalBtn)}
							>
								Add Goal
							</button>
						</form>

						<List items={this.props.goals} onRemoveItem={this.onRemoveGoal} />
					</div>
				);
			}
		}

		const ConnectedGoals = ReactRedux.connect((state) => ({
			goals: state.goals
		}))(Goals)

		class App extends React.Component {

			componentDidMount () {
				const { dispatch } = this.props;

				dispatch(
					receiveDataThunk((error, todos, goals) => {
						if (error) {
							return alert(error.message)
						}
					})
				)
			}

			render() {
				const { loading } = this.props;

				if (loading) {
					return <h3>Loading...</h3>
				}

				return (
					<div>
						<ConnectedTodos />
						<ConnectedGoals />
					</div>
				);
			}
		}

		const ConnectedApp = ReactRedux.connect((state) => ({
			loading: state.loading
		}))(App)

		ReactDOM.render(
			<ReactRedux.Provider store={ store }>
				<ConnectedApp />
			</ReactRedux.Provider>,
			document.getElementById('app-root')
		);
	</script>
</body>
</html>